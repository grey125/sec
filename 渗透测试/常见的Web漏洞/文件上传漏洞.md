### 文件上传漏洞简介

	文件上传漏洞是指由于程序未对上传的文件进行严格的验证和过滤及限制，而导致用户可以越过其本身权限向服务器上传可执行的动态脚本文件。

### 文件上传漏洞利用技巧

#### 任意文件上传

##### 代码

```PHP

<?php 
if( isset( $_POST[ 'Upload' ] ) ) {
	$target_path = "uploads/";
	$target_path .= basename("2022".rand(0,9999999999).$_FILES[ 'uploaded' ][ 'name' ] );
	$uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];
	$uploaded_type = $_FILES[ 'uploaded' ][ 'type' ];
	$uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];
	if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) )
	{
		echo '<pre>上传失败!</pre>';
	} else { 
		echo "<pre>{$target_path} 上传成功!</pre>";
		}
	}
?>

```

#### Content-type 验证绕过
	服务端对 Content-type 进行验证，通过修改 Content-type 然后上传任意文件

##### 代码

```PHP

<?php 
if( isset( $_POST[ 'Upload' ] ) ) 
{ 
	$target_path = "uploads/";
	$target_path .= basename("2019".rand(0,9999999999).$_FILES[ 'uploaded' ][ 'name' ] );
	$uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];
	$uploaded_type = $_FILES[ 'uploaded' ][ 'type' ];
	$uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];
	if( ( $uploaded_type == "image/jpeg" || $uploaded_type == "image/png" || $uploaded_type == "image/gif" ) && ( $uploaded_size < 1000000 ) )
	{ 
		if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) )
		{ 
			echo '<pre>上传失败!</pre>';
		} else {
			echo "<pre>{$target_path} 上传成功!</pre>";
			}
	} else {
		echo '<pre>只允许上传JPEG/PNG格式.</pre>';
	}
}


?>

```

```PHP
#上传文件时修改 Content-type
Content-Type:image/jpeg
```

#### JavaScript 验证绕过
	客户端js代码针对用户对文件上传所作的限制，在服务端没有做任何限制的情况下可以通过删除js验证代码进行绕过。

##### 客户端代码

```html

<h4 style="color:DarkCyan">To upload Js</h4><br>
<form  action="/upload/post_js" onsubmit="return checkupload();" method="POST"enctype="multipart/form-data">
<h5 style="color:Red">File：<input type="file" id="uploadfile" name="uploaded">
<input type="submit" value="Upload" name="Upload"></h5>
</form>';

<script type="text/javascript">
	function checkupload(){
		var filetag=document.getElementById("uploadfile")
		var filename=filetag.value;
		var lastpos=filename.lastIndexOf(".");
		var ext = filename.substring(lastpos+1);
		if (ext !="jpeg" && ext !="png" && ext !="gif" && ext !="jpg"){
		    alert("文件类型错误，上传失败");
		    return false;
		}
	}
</script>

```

##### 服务端代码

```PHP

if( isset( $_POST[ 'Upload' ] ) ) {
	$target_path = "uploads/";
	$target_path .= basename("2022".rand(0,9999999999).$_FILES[ 'uploaded' ][ 'name' ] );
	$uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];
	$uploaded_type = $_FILES[ 'uploaded' ][ 'type' ];
	$uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];
	if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) )
	{
		echo '<pre>上传失败!</pre>';
	} else { 
		echo "<pre>{$target_path} 上传成功!</pre>";
		}
	}
}

```


```html

<!--删除onsubmit-->

<form  action="/upload/post_js" onsubmit="return checkupload();" method="POST"enctype="multipart/form-data">
<h5 style="color:Red">File：<input type="file" id="uploadfile" name="uploaded">
<input type="submit" value="Upload" name="Upload"></h5>
</form>

```